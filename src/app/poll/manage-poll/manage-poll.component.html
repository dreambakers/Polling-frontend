<div class="p-5" *ngIf="poll?.questions">

    <div class="d-flex flex-column">
        <div class="w-75 mb-3">
            <h3>Manage Poll</h3>
        </div>

        <small *ngIf="poll.status === constants.statusTypes.terminated" class="mb-3">
            You cannot edit this poll because it was terminated.
        </small>

        <small *ngIf="poll.status !== constants.statusTypes.terminated && responses && responses.length" class="mb-3">
            You cannot edit this poll because it already has responses.
        </small>

        <div class="d-flex flex-column justify-content-end mb-5 text-right">
            <p class="mb-1"><span class="font-weight-bold">Poll ID: </span>{{poll._id}}</p>
            <p *ngIf="responses.length"><span class="font-weight-bold">Responders: </span>{{responses.length}}</p>
        </div>

        <mat-card>
            <mat-form-field appearance="outline" class="w-100 mb-3 mt-3">
                <mat-label>Title</mat-label>
                <input matInput placeholder="A poll about food" [(ngModel)]="poll.title" [disabled]="shouldDisable">
                <mat-hint *ngIf="!shouldDisable">Type poll title</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-100 mb-3">
                <mat-label>Description</mat-label>
                <textarea matInput placeholder="Poll description" [(ngModel)]="poll.description" [disabled]="shouldDisable">
                </textarea>
                <mat-hint *ngIf="!shouldDisable">Type poll description</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-100 mb-3" *ngIf="!shouldDisable && poll.privateNote">
                <mat-label>Private note</mat-label>
                <textarea matInput placeholder="Private note" [(ngModel)]="poll.privateNote" [disabled]="shouldDisable">
                </textarea>
                <mat-hint *ngIf="!shouldDisable">Type private note (not visible to responders)</mat-hint>
            </mat-form-field>
        </mat-card>
    </div>


    <div class="d-flex justify-content-end my-4" *ngIf="!shouldDisable">
        <mat-slide-toggle (change)="toggleRearrangement()">
            Rearrange questions
        </mat-slide-toggle>
    </div>

    <div cdkDropList (cdkDropListDropped)="dropQuestion($event)" [class.mt-5]="shouldDisable">
        <mat-card *ngFor="let question of poll.questions; let i = index" class="border p-3 mb-1" cdkDrag
            [class.mb-5]="!rearrangeQuestions" [cdkDragDisabled]="!rearrangeQuestions"
            [class.border-danger]="minimumOptionsRequired(question) && question.options.length < 2">

            <div class="d-flex" *ngIf="rearrangeQuestions">
                <input matInput disabled [value]="question.text || 'No question entered'" [class.font-italic]="!question.text">
                <div class="example-handle" cdkDragHandle>
                    <svg width="24px" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z">
                        </path>
                        <path d="M0 0h24v24H0z" fill="none"></path>
                    </svg>
                </div>
            </div>

            <div class="w-100 d-flex justify-content-end align-items-center" *ngIf="!rearrangeQuestions">
                <mat-icon
                    class="mb-3 mr-2 cursor-pointer text-muted"
                    matTooltip="This answer type requires a minimum of 2 options"
                    matTooltipPosition="above"
                    *ngIf="minimumOptionsRequired(question)">
                    info
                </mat-icon>
                <mat-form-field>
                    <mat-label>Answers</mat-label>
                    <mat-select [(value)]="question.answerType" [disabled]="shouldDisable">
                      <mat-option [value]="constants.answerTypes.binary">Yes/No</mat-option>
                      <mat-option [value]="constants.answerTypes.rating">5 star rating</mat-option>
                      <mat-option [value]="constants.answerTypes.checkbox">Checkbox</mat-option>
                      <mat-option [value]="constants.answerTypes.radioButton">Radiobutton</mat-option>
                      <mat-option [value]="constants.answerTypes.yesNoMaybe">Yes/No/Maybe</mat-option>
                      <mat-option [value]="constants.answerTypes.slider">Slider</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="w-100 mb-5" *ngIf="!rearrangeQuestions">
                <mat-label>Question {{i + 1}}</mat-label>
                <input matInput placeholder="What is your favorite food?" [(ngModel)]="question.text" [disabled]="shouldDisable">
                <mat-hint *ngIf="!shouldDisable">Type question {{i + 1}}</mat-hint>
            </mat-form-field>

            <div class="d-flex justify-content-end mb-2" *ngIf="question.options.length && !rearrangeQuestions && !shouldDisable">
                <mat-slide-toggle (change)="rearrangeOptions(question)">
                    Rearrange options
                </mat-slide-toggle>
            </div>

            <div *ngIf="!rearrangeQuestions" cdkDropList (cdkDropListDropped)="dropOption($event, question)">
                <div *ngFor="let option of question.options; let j = index; trackBy: trackByFn" cdkDrag
                     [cdkDragDisabled]="!question.rearrangeOptions">
                    <div class="d-flex align-items-center justify-content-between">
                        <mat-form-field appearance="outline" [ngClass]="responses.length ? 'w-85': 'w-100'">
                            <mat-label>Question {{ i + 1 }} option {{ j + 1 }}</mat-label>
                            <input matInput placeholder="Pizza" [(ngModel)]="question.options[j]" [disabled]="shouldDisable">
                        </mat-form-field>

                        <div *ngIf="responses.length" class="w-15 text-right">
                            <span class="font-weight-bold">Response: </span> {{answerMap[i][j].response}} %
                        </div>

                        <button mat-button class="btn btn-danger ml-1 mb-4" (click)="removeOption(i,j)"
                               *ngIf="!question.rearrangeOptions && !shouldDisable">
                            <mat-icon>
                                delete
                            </mat-icon>
                        </button>

                        <div class="example-handle ml-1 mb-4" cdkDragHandle *ngIf="question.rearrangeOptions">
                            <svg width="24px" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z">
                                </path>
                                <path d="M0 0h24v24H0z" fill="none"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="!rearrangeQuestions && !shouldDisable">
                <button class="btn btn-primary" (click)="addOption(i)">
                    Add {{question.options.length ? 'another' : ''}} option
                </button>
                <button class="btn btn-danger float-right" (click)="removeQuestion(i)">
                    Remove question
                </button>
            </div>

            <div *ngIf="responses.length && !question.options.length">
                <hr>
                <mat-label><span class="font-weight-bold">Response: </span> {{answerMap[i][0].response}} %</mat-label>
            </div>
        </mat-card>
    </div>

    <div class="text-center mt-5" *ngIf="!shouldDisable">
        <button class="btn btn-info mb-5" (click)="addQuestion()">
            Add another question
        </button>

        <br>

        <div class="btn btn-success" (click)="isValid && dirty && updatePoll()" [class.disabled]="!isValid || !dirty"
            matTooltip="{{ !isValid ? 'Please fill all the required fields' : (!dirty ? 'Change some fields to update the poll' : '' ) }}">
            Update
        </div>
    </div>
</div>